<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoonya Trading Bot</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .login-form, .dashboard, .config-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn-primary {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 16px;
        }
        .btn-primary:hover {
            background-color: #218838;
        }
        .error {
            color: red;
            text-align: center;
            margin-bottom: 15px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .navbar {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">Shoonya Trading Bot</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                {% if user_id %}
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Logout</a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="/">Login</a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="container">
        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}

        {% if not user_id %}
            <!-- Login Form -->
            <div class="login-form">
                <h1>Login to Shoonya Trading Bot</h1>
                <form id="login-form" method="POST" action="/login">
                    <div class="form-group">
                        <label for="user-id">User ID</label>
                        <input id="user-id" name="user-id" type="text" class="form-control" placeholder="User ID" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input id="password" name="password" type="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label for="totp">TOTP (6-digit code)</label>
                        <input id="totp" name="totp" type="text" class="form-control" placeholder="TOTP" required>
                    </div>
                    <div class="form-group">
                        <label for="vendor-code">Vendor Code</label>
                        <input id="vendor-code" name="vendor-code" type="text" class="form-control" placeholder="Vendor Code" required>
                    </div>
                    <div class="form-group">
                        <label for="api-secret">API Secret</label>
                        <input id="api-secret" name="api-secret" type="text" class="form-control" placeholder="API Secret" required>
                    </div>
                    <div class="form-group">
                        <label for="imei">IMEI</label>
                        <input id="imei" name="imei" type="text" class="form-control" placeholder="IMEI" required>
                    </div>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
            </div>
        {% else %}
            <!-- Dashboard -->
            <div class="dashboard">
                <h1>Welcome, {{ user_id }}!</h1>
                <h2>Account Summary</h2>
                <p>Balance: {{ balance | default('Loading...') }}</p>
                <h2>Open Orders</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Symbol</th>
                            <th>Quantity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                            <tr>
                                <td>{{ order.id | default('N/A') }}</td>
                                <td>{{ order.symbol | default('N/A') }}</td>
                                <td>{{ order.quantity | default('N/A') }}</td>
                                <td>{{ order.status | default('N/A') }}</td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4">No open orders</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Trade Configuration Form -->
            <div class="config-form">
                <h2>Trade Configuration</h2>
                {% if config_error %}
                    <p class="error">{{ config_error }}</p>
                {% endif %}
                <form id="trade-config-form" method="POST" action="/configure">
                    <div class="form-group">
                        <label for="instrument-type">Instrument Type</label>
                        <select id="instrument-type" name="instrument-type" class="form-control" required>
                            <option value="option" {% if config.instrument_type == 'option' %}selected{% endif %}>Option</option>
                            <option value="future" {% if config.instrument_type == 'future' %}selected{% endif %}>Future</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="index">Index</label>
                        <input id="index" name="index" type="text" class="form-control" value="{{ config.index | default('NIFTY') }}" required>
                    </div>
                    <div class="form-group">
                        <label for="trade-type">Trade Type</label>
                        <select id="trade-type" name="trade-type" class="form-control" required>
                            <option value="buy" {% if config.trade_type == 'buy' %}selected{% endif %}>Buy</option>
                            <option value="sell" {% if config.trade_type == 'sell' %}selected{% endif %}>Sell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expiry">Expiry</label>
                        <input id="expiry" name="expiry" type="text" class="form-control" value="{{ config.expiry | default('current_week') }}" required>
                    </div>
                    <div class="form-group">
                        <label for="strike">Strike</label>
                        <input id="strike" name="strike" type="text" class="form-control" value="{{ config.strike | default('ATM') }}" required>
                    </div>
                    <button type="submit" class="btn-primary">Save Configuration</button>
                </form>
            </div>
        {% endif %}
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            // TOTP validation
            $('#login-form').submit(function(e) {
                var totp = $('#totp').val();
                if (!/^\d{6}$/.test(totp)) {
                    e.preventDefault();
                    alert('TOTP must be a 6-digit number');
                }
            });

            // Optional: AJAX for login (commented out to match server-side)
            /*
            $('#login-form').submit(function(e) {
                e.preventDefault();
                $.post('/login', $(this).serialize(), function(data) {
                    if (data.success) {
                        window.location = '/';
                    } else {
                        $('.error').text('Login failed: ' + data.error);
                    }
                });
            });
            */
        });
    </script>
</body>
</html>